<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Courier</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#07080c;
      --panel:#0f111a;
      --stroke:#20234a;
      --stroke2:#2a2e5d;
      --text:#e8e8ef;
      --muted:#a6a7bf;
      --blue:#38bdf8;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
      --r2:12px;
      --pad:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1100px 700px at 50% -10%, rgba(59,130,246,.18), transparent 55%),
        radial-gradient(900px 600px at 10% 35%, rgba(56,189,248,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 35%, rgba(236,72,153,.08), transparent 60%),
        var(--bg);
      color:var(--text);
    }

    .safe{
      padding: calc(env(safe-area-inset-top) + 10px) 12px calc(env(safe-area-inset-bottom) + 86px);
      max-width:720px;
      margin:0 auto;
    }

    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    h1{margin:0; font-size:18px; letter-spacing:.2px;}
    .sub{margin-top:2px; font-size:12px; color:var(--muted);}

    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background: rgba(15,17,26,.65);
      border-radius:999px;
      box-shadow: var(--shadow);
      user-select:none; -webkit-user-select:none;
      font-weight:900; font-size:12px;
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background:var(--good);
      box-shadow:0 0 0 4px rgba(52,211,153,.12);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:10px;}
    .card{
      background: linear-gradient(180deg, rgba(15,17,26,.92), rgba(11,13,20,.88));
      border:1px solid var(--stroke);
      border-radius:var(--r);
      padding:var(--pad);
      box-shadow: var(--shadow);
    }

    .row{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .muted{color:var(--muted); font-size:12px;}
    .strong{font-weight:950; font-size:12px;}

    .jobs{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;}
    .job{
      border:1px solid var(--stroke2);
      background: rgba(7,8,12,.35);
      border-radius:14px;
      padding:12px;
    }
    .jobTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .jobName{font-weight:950; letter-spacing:.2px;}
    .meta{
      margin-top:8px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      color: rgba(232,232,239,.92);
    }

    .btn{
      width:100%;
      border:1px solid var(--stroke2);
      background: rgba(23,24,38,.85);
      color: var(--text);
      border-radius:14px;
      padding:12px 10px;
      font-size:13px;
      font-weight:950;
      letter-spacing:.2px;
      text-align:center;
      user-select:none; -webkit-user-select:none;
      touch-action: manipulation;
    }
    .btn:active{transform: translateY(1px);}
    .btn[disabled]{opacity:.45; filter:saturate(.7);}

    .bar{
      height:14px;
      border:1px solid var(--stroke2);
      border-radius:999px;
      background: rgba(7,8,12,.5);
      overflow:hidden;
      margin-top:10px;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(59,130,246,.95));
      transition: width .10s linear;
    }

    .big{
      font-size:20px;
      font-weight:950;
      letter-spacing:.2px;
    }

    /* Bottom speed bar */
    .speedbar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding: 10px 12px calc(env(safe-area-inset-bottom) + 10px);
      background: rgba(7,8,12,.75);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(42,46,93,.8);
    }
    .speedwrap{
      max-width:720px;
      margin:0 auto;
      border:1px solid var(--stroke);
      background: rgba(15,17,26,.75);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 10px;
    }
    .speedhead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .speedtitle{font-weight:950; font-size:12px;}
    .speedval{font-family:var(--mono); font-size:12px; color:rgba(232,232,239,.92);}
    .seg{
      display:grid;
      grid-template-columns:repeat(5,1fr);
      gap:8px;
    }
    .seg button{
      border:1px solid var(--stroke2);
      background: rgba(23,24,38,.65);
      color: var(--muted);
      border-radius: 12px;
      padding: 10px 0;
      font-weight:950;
      font-size:12px;
      touch-action: manipulation;
    }
    .seg button.active{
      color: var(--text);
      border-color: rgba(56,189,248,.55);
      box-shadow: 0 0 0 4px rgba(56,189,248,.10);
      background: rgba(23,24,38,.95);
    }
    .seg button:active{transform: translateY(1px);}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 96px);
      background: rgba(15,17,26,.92);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      box-shadow: var(--shadow);
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
      max-width:90vw;
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

    .hidden{display:none !important;}
  </style>
</head>

<body>
  <div class="safe">
    <div class="top">
      <div>
        <h1>Courier</h1>
        <div class="sub">Select job → do job (live) → complete → repeat</div>
      </div>
      <div class="pill" title="State">
        <span class="dot" id="dot"></span>
        <span id="mode">Choosing</span>
      </div>
    </div>

    <div class="grid">
      <!-- JOB BOARD -->
      <div class="card" id="boardCard">
        <div class="row">
          <div class="strong">Job board</div>
          <div class="muted" id="boardMeta">—</div>
        </div>
        <div class="jobs" id="jobs"></div>
        <div style="height:10px"></div>
        <button class="btn" id="refreshBtn">Refresh jobs</button>
      </div>

      <!-- IN-JOB (live) -->
      <div class="card hidden" id="jobCard">
        <div class="row">
          <div class="strong" id="jobName">—</div>
          <div class="muted" id="jobRight">—</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="muted">Time remaining</div>
          <div class="big" id="timeLeft">—</div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="muted">Progress</div>
          <div class="strong" id="pct">0%</div>
        </div>
        <div class="bar"><div class="fill" id="fill"></div></div>

        <div class="row" style="margin-top:10px;">
          <div class="muted" id="paceHint">Speed affects progress rate</div>
          <div class="strong" id="deadlineHint">On time</div>
        </div>

        <div style="height:10px"></div>
        <button class="btn" id="cancelBtn">Cancel job</button>
      </div>

      <!-- RESULT -->
      <div class="card hidden" id="resultCard">
        <div class="row">
          <div class="strong" id="resultTitle">—</div>
          <div class="muted" id="resultTag">—</div>
        </div>
        <div style="height:10px"></div>
        <div class="big" id="resultLine">—</div>
        <div style="height:10px"></div>
        <button class="btn" id="backBtn">Back to job board</button>
      </div>
    </div>
  </div>

  <!-- Bottom speed selector (only visible during job) -->
  <div class="speedbar hidden" id="speedBar">
    <div class="speedwrap">
      <div class="speedhead">
        <div class="speedtitle">Speed</div>
        <div class="speedval" id="speedLabel">3 • average</div>
      </div>
      <div class="seg" id="speedSeg"></div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

<script>
/*
  Requirements implemented:
  - Core loop only: select job -> live job -> complete -> repeat
  - No reputation shown
  - No step clicking: progress updates continuously
  - Each job has distance + deadline
  - Deadline == time to travel at average speed (3)
  - Minutes are treated as seconds (prototype scaling)
  - Speed control: bottom bar, 5 discrete settings (1..5)
*/

const GAME = {
  jobsShown: 3,
  // Speed multipliers relative to "average" (3).
  // At 3, you hit exactly 100% at the deadline.
  // Below 3 you will miss; above 3 you will finish early.
  speed: {
    1: { name:"very slow", mult: 0.55 },
    2: { name:"slow",      mult: 0.80 },
    3: { name:"average",   mult: 1.00 },
    4: { name:"fast",      mult: 1.25 },
    5: { name:"very fast", mult: 1.55 }
  },
  // Average mph isn't shown; used only to derive baseline time from distance.
  // DeadlineSeconds = (distanceMiles / avgMph) * 60  (minutes), then minutes==seconds => keep numeric value as seconds.
  avgMph: 8.0,
  jobTypes: [
    { id:"food",   name:"Hot food drop",  dist: 2.0 },
    { id:"parcel", name:"Parcel run",     dist: 3.5 },
    { id:"groc",   name:"Groceries",      dist: 4.2 },
    { id:"frag",   name:"Fragile item",   dist: 5.0 },
    { id:"rush",   name:"Rush SLA",       dist: 6.0 }
  ]
};

const state = {
  mode: "choosing", // choosing | in_job | result
  offers: [],
  job: null,
  speed: 3,

  // live job fields
  t0: 0,
  lastTick: 0,
  elapsed: 0,
  progress: 0,
  deadline: 0, // seconds (prototype-scaled)
  running: false,
  raf: 0
};

const $ = (id) => document.getElementById(id);
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._to);
  toast._to = setTimeout(()=>t.classList.remove("show"), 1000);
}

function setMode(m){
  state.mode = m;
  $("mode").textContent = m === "choosing" ? "Choosing" : (m === "in_job" ? "In job" : "Result");

  const dot = $("dot");
  if (m === "choosing"){
    dot.style.background = "var(--good)";
    dot.style.boxShadow = "0 0 0 4px rgba(52,211,153,.12)";
  } else if (m === "in_job"){
    dot.style.background = "var(--blue)";
    dot.style.boxShadow = "0 0 0 4px rgba(56,189,248,.12)";
  } else {
    dot.style.background = "var(--warn)";
    dot.style.boxShadow = "0 0 0 4px rgba(251,191,36,.14)";
  }

  $("boardCard").classList.toggle("hidden", m !== "choosing");
  $("jobCard").classList.toggle("hidden", m !== "in_job");
  $("resultCard").classList.toggle("hidden", m !== "result");
  $("speedBar").classList.toggle("hidden", m !== "in_job");
}

function formatSeconds(s){
  const sec = Math.max(0, Math.ceil(s));
  return `${sec}s`; // prototype: "minutes == seconds"
}

function deadlineFromDistanceMiles(miles){
  // baseline minutes = miles / mph * 60; then minutes treated as seconds => numeric value used as seconds
  const minutes = (miles / GAME.avgMph) * 60;
  const seconds = Math.max(8, Math.round(minutes)); // clamp so tiny jobs still visible
  return seconds;
}

function generateOffers(){
  const pool = GAME.jobTypes.slice();
  for (let i=pool.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [pool[i],pool[j]] = [pool[j],pool[i]];
  }
  const pick = pool.slice(0, GAME.jobsShown);

  state.offers = pick.map((t, idx) => {
    const deadline = deadlineFromDistanceMiles(t.dist);
    return {
      offerId: `${t.id}_${Date.now()}_${idx}`,
      name: t.name,
      dist: t.dist,
      deadline
    };
  });

  $("boardMeta").textContent = `${state.offers.length} available`;
}

function renderOffers(){
  const wrap = $("jobs");
  wrap.innerHTML = "";
  for (const o of state.offers){
    const div = document.createElement("div");
    div.className = "job";
    div.innerHTML = `
      <div class="jobTop">
        <div class="jobName">${escapeHtml(o.name)}</div>
        <div class="muted">${o.dist.toFixed(1)} mi</div>
      </div>
      <div class="meta">deadline: ${o.deadline}s (avg speed)</div>
      <div style="height:10px"></div>
      <button class="btn" data-pick="${o.offerId}">Select job</button>
    `;
    div.querySelector("button").addEventListener("click", () => startJob(o.offerId));
    wrap.appendChild(div);
  }
}

function buildSpeedUI(){
  const seg = $("speedSeg");
  seg.innerHTML = "";
  for (let i=1;i<=5;i++){
    const b = document.createElement("button");
    b.type = "button";
    b.textContent = String(i);
    b.dataset.speed = String(i);
    b.addEventListener("click", () => setSpeed(i));
    seg.appendChild(b);
  }
  syncSpeedUI();
}

function setSpeed(s){
  state.speed = clamp(s,1,5);
  syncSpeedUI();
}

function syncSpeedUI(){
  const label = GAME.speed[state.speed];
  $("speedLabel").textContent = `${state.speed} • ${label.name}`;

  const buttons = $("speedSeg").querySelectorAll("button");
  buttons.forEach(b => b.classList.toggle("active", Number(b.dataset.speed) === state.speed));
}

function startJob(offerId){
  const offer = state.offers.find(x => x.offerId === offerId);
  if (!offer) return;

  cancelAnimationFrame(state.raf);

  state.job = offer;
  state.elapsed = 0;
  state.progress = 0;
  state.deadline = offer.deadline;
  state.running = true;
  state.lastTick = performance.now();

  $("jobName").textContent = offer.name;
  $("jobRight").textContent = `${offer.dist.toFixed(1)} mi`;
  $("fill").style.width = "0%";
  $("pct").textContent = "0%";
  $("deadlineHint").textContent = "On time";
  $("timeLeft").textContent = formatSeconds(state.deadline);

  setMode("in_job");
  toast("Job started");

  tick();
}

function finishJob(success){
  state.running = false;
  cancelAnimationFrame(state.raf);

  const title = success ? "Delivered" : "Late";
  const tag = success ? "Complete" : "Missed";
  const line = success ? "Job completed before the deadline." : "Deadline hit before completion.";

  $("resultTitle").textContent = title;
  $("resultTag").textContent = tag;
  $("resultLine").textContent = line;

  setMode("result");
}

function tick(){
  if (!state.running) return;

  const now = performance.now();
  const dt = (now - state.lastTick) / 1000;
  state.lastTick = now;

  // Update timers
  state.elapsed += dt;

  const timeRemaining = state.deadline - state.elapsed;

  // Progress model:
  // At speed 3 (mult=1.0), progress reaches 1.0 exactly at deadline.
  const mult = GAME.speed[state.speed].mult;
  const baseRate = 1 / state.deadline;       // progress per second at avg speed
  state.progress = clamp(state.progress + (baseRate * mult * dt), 0, 1);

  // Render
  $("timeLeft").textContent = formatSeconds(timeRemaining);
  const pct = Math.floor(state.progress * 100);
  $("pct").textContent = `${pct}%`;
  $("fill").style.width = `${state.progress * 100}%`;

  // "On time" hint: compare remaining progress vs remaining time at avg pace
  // If current speed is < 3, it's likely late unless you speed up; keep it simple.
  const onTime = state.progress >= (state.elapsed / state.deadline) - 0.001;
  $("deadlineHint").textContent =
    timeRemaining <= 0 ? "Deadline hit" :
    onTime ? "On time" : "Behind";

  // Terminal conditions
  if (state.progress >= 1){
    finishJob(true);
    toast("Complete");
    return;
  }
  if (timeRemaining <= 0){
    finishJob(false);
    toast("Late");
    return;
  }

  state.raf = requestAnimationFrame(tick);
}

function cancelJob(){
  state.running = false;
  cancelAnimationFrame(state.raf);
  state.job = null;
  setMode("choosing");
  toast("Cancelled");
}

function backToBoard(){
  state.job = null;
  generateOffers();
  renderOffers();
  setMode("choosing");
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

// UI wiring
$("refreshBtn").addEventListener("click", () => { generateOffers(); renderOffers(); toast("Refreshed"); });
$("cancelBtn").addEventListener("click", cancelJob);
$("backBtn").addEventListener("click", backToBoard);

// Init
buildSpeedUI();
generateOffers();
renderOffers();
setMode("choosing");
</script>
</body>
</html>